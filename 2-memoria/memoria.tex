\documentclass[12pt,a4paper]{article}
\usepackage{graphicx}
\usepackage[utf8]{inputenc}
\usepackage{titling}
\usepackage{hyperref}
\usepackage{fancyhdr}
\usepackage[headsep=1.5cm]{geometry}
\usepackage{float} % Para que los floats se estén quietecitos

%%% LISTINGS %%%
\usepackage{listings}
\usepackage{lstautogobble}  % Fix relative indenting
\usepackage{color}          % Code coloring
\usepackage{zi4}            % Nice font

\definecolor{bluekeywords}{rgb}{0.13, 0.13, 1}
\definecolor{greencomments}{rgb}{0, 0.5, 0}
\definecolor{redstrings}{rgb}{0.9, 0, 0}
\definecolor{graynumbers}{rgb}{0.5, 0.5, 0.5}

\usepackage{listings}
\lstset{
    autogobble,
    columns=fullflexible,
    showspaces=false,
    showtabs=false,
    breaklines=true,
    showstringspaces=false,
    breakatwhitespace=true,
    escapeinside={(*@}{@*)},
    commentstyle=\color{greencomments},
    keywordstyle=\color{bluekeywords},
    stringstyle=\color{redstrings},
    numberstyle=\color{graynumbers},
    basicstyle=\footnotesize\ttfamily,
    frame=l,
    framesep=12pt,
    xleftmargin=12pt,
    tabsize=4,
    captionpos=b
}
%%% /LISTINGS %%%





\title{Configuració de Ports}
\author{
    Iván Canales% Martín
    \\
    Xavier Ripoll% Echeveste
}

\date{9 de març de 2018}

\pagestyle{fancy}
\fancyhf{}

% Head
\lhead{\small\theauthor}
\chead{\small Programació d'Arquitectures\\Encastades}
\rhead{\small Pràctica 2:\\Configuració de Ports}

% Foot
\cfoot{\thepage}

\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%% TITLE PAGE %%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% un dia de estos lo hago plantilla
\begin{titlepage}
	\centering
	{\scshape\LARGE Universitat de Barcelona \par}
	\vspace{2cm}
	{\scshape\Large Pràctica 2:\par}
	\vspace{1cm}
	{\huge\bfseries \thetitle \par}

    \vfill
    \large\theauthor
	\vfill
	\raggedleft

    \par

    %\hrulefill\par
    {\scshape Programació d'Arquitectures Encastades\par}
    \texttt{}{Curs 2017-2018\par} %Universitat de Barcelona
    \thedate

% Bottom of the page

\end{titlepage} \pagebreak
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introducció}

\subsection{Objectius}
% Què es vol fer a la pràctica.

En la pràctica es pretén introduir els GPIOs (\textit{General Purpose
Input/Output} o entrades i sortides de propòsit general). Per fer-ho,
programarem algunes entrades del robot (el \textit{joystick} i dos botons) per
a que modifiquin algunes sortides (la pantalla de la placa superior i uns LEDs),
segons la següent taula:

\begin{table}[H]
  \centering
  \begin{tabular}{|l||l|l|l||l|} \hline
    Estat & LED B    & LED G    & LED R    & Botó   \\ \hline
    1     & 1        & 1        & 1        & S1     \\ \hline
    2     & 0        & 0        & 0        & S2     \\ \hline
    3     & 1        & 1        & 1        & Left   \\ \hline
    4     & 0        & 1        & 1        & Right  \\ \hline
    5     & 1        & 0        & 1        & Up     \\ \hline
    6     & 1        & 1        & 0        & Down   \\ \hline
    7     & Invertir & Invertir & Invertir & Center \\ \hline
  \end{tabular}
\end{table}

A més a més, els controls horitzontals del \textit{joystick} marquen la direcció
en què circula un senyal a través dels LEDs de la placa inferior, i els controls
verticals, la velocitat a la que es mou el senyal.

Per a que aquests dos comportaments es realitzin correctament i en temps real,
cal que considerem la \textit{sincronia} del codi. Per això emprem uns mètodes
anomenats \textit{handlers} que són cridats quan hi ha una interrupció (en el
nostre cas, quan es prem un botó o el \textit{joystick}), i és important que
qualsevol tasca que realitzem en el bucle principal no sigui bloquejant.

\subsection{Recursos utilitzats}
% Quins recursos del Microcontrolador, Placa d’Experimentació i Robot es fan servir.
De la placa \textit{Boosterpack MK II} volem fer servir:

\begin{itemize}
    \item Entrades: el \textit{joystick}, els polsadors S1 i S2
    \item Sortides: el LED RGB
\end{itemize}

De la Placa d'experimentació, farem servir els vuit LEDs del port P7.

De la placa d'interfície farem servir els 8 LEDs del port 8 (com sortida).

\subsection{Configuració dels recursos}
% Com s’han configurat els diferents recursos.
\subsubsection{Configuració dels LEDs}
Es posen els LEDs RGB (pins P2.6, P2.4 i P5.6 respectivament) com a sortides ($DIR = 1$) digitals ($SEL0 = SEL1 = 0$) i es posen a 0 (apagats).

\begin{lstlisting}[language=C++]
P2DIR |=  0x50; //Pines P2.4 (G), 2.6 (R) como salidas Led (RGB)
P5DIR |=  0x40; //Pin P5.6 (B)como salida Led (RGB)
P2OUT &= ~0x50; //Inicializamos Led RGB a 0 (apagados)
P5OUT &= ~0x40; //Inicializamos Led RGB a 0 (apagados)
\end{lstlisting}

\subsubsection{Configuració dels botons}

Es posen els botons com entrades ($DIR = 0$) digitals ($SEL0 = SEL1 = 0$). Volem que la transició sigui en el flanc de pujada ($IES = 0$). finalment activem les interrupcions i netegem els flags.

\begin{lstlisting}[language=C++]
//Boton S1
P5DIR  &= ~0x02; //Pin P5.1 como entrada
P5SEL0 &= ~0x02; //Pin P5.1 como I/O digital,
P5SEL1 &= ~0x02; //Pin P5.1 como I/O digital,
P5IES  &= ~0x02; // con transicion L->H
P5IE   |=  0x02; //Interrupciones activadas en P5.1,
P5IFG   =     0; //Limpiamos todos los flags
\end{lstlisting}

\begin{lstlisting}[language=C++]
//Boton S2 del MK II:
P3DIR  &= ~0x20; //Pin P3.5 como entrada
P3SEL0 &= ~0x20; //Pin P3.5 como I/O digital,
P3SEL1 &= ~0x20; //Pin P3.5 como I/O digital,
P3IES  &= ~0x20; // con transicion L->H
P3IE   |=  0x20; //Interrupciones activadas en P3.5
P3IFG   =     0; //Limpiamos todos los flags de las interrupciones del puerto 3
\end{lstlisting}

\subsubsection{Configuració del joystick}

De la mateixa manera que els botons, es posen els bits del \textit{joystick} com entrades ($DIR = 0$) digitals ($SEL0 = SEL1 = 0$) amb transició per flanc de pujada.
\begin{lstlisting}[language=C++]
//PIN 4
P4DIR  &= ~(BIT1 + BIT5 + BIT7); //Posar com entrades,
P4SEL0 &= ~(BIT1 + BIT5 + BIT7); //Posar a I/O digital,
P4SEL1 &= ~(BIT1 + BIT5 + BIT7); //
P4REN  |=   BIT1 + BIT5 + BIT7;  //Activar resistencia pullup
P4OUT  |=   BIT1 + BIT5 + BIT7;  //
P4IE   |=   BIT1 + BIT5 + BIT7;  //Interrupcions activadas
P4IES  &= ~(BIT1 + BIT5 + BIT7); //Interrupcions L->H
P4IFG   = 0;    //Netejar flags

//PIN 5
P5DIR  &= ~(BIT4 + BIT5); //Posar com entrades,
P5SEL0 &= ~(BIT4 + BIT5); //Posar a I/O digital,
P5SEL1 &= ~(BIT4 + BIT5); //
P5REN  |=   BIT4 + BIT5 ; //Activar resistencia pullup
P5OUT  |=   BIT4 + BIT5 ; //
P5IE   |=   BIT4 + BIT5 ; //Activar intrrupcions
P5IES  &= ~(BIT4 + BIT5); //Interrupcions L->HL->H
P5IFG = 0;    //Netejar flags
\end{lstlisting}

\subsubsection{Configuració dels LEDs del port P7}

Cal que posem tots els LEDs como a salida digital (igual que els LEDs RGB).

\begin{lstlisting}[language=C++]
P7DIR  |= 0xFF; // Todos de salida
P7SEL0 &= 0x00; // Todos GPIO
P7SEL1 &= 0x00;
P7OUT  &= 0x00;  // Todos apagados
\end{lstlisting}

%\subsection{Funcions utilitzades}
% Com i per quines funcions es fan servir.


\subsection{Problemes}
% Problemes que han sorgit (que no siguin de compilació) i com s’han solucionat.
Durant la implementació de la practica vam descartar l'ús de \texttt{delay\_t} y en la gestió del moviment dels leds del port P7, doncs és una funció bloquejant, i volem que encara que els leds es moguin es pugin modificar els estats.

En quant a hardware, vam trobar que un dels leds del port P7 no funcionaba, fet que va dificultar el testeig del programa.

\subsection{Conclusions}

\section{Comentari del codi}

\end{document}
